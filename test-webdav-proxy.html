<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebDAV ä»£ç†æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }
        input[type="text"],
        input[type="password"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            box-sizing: border-box;
        }
        input[type="checkbox"] {
            margin-right: 5px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            display: block;
        }
        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            display: block;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .code {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª WebDAV ä»£ç†æµ‹è¯•å·¥å…·</h1>
        <p class="subtitle">æµ‹è¯•æ‚¨çš„ WebDAV ä»£ç†æœåŠ¡å™¨æ˜¯å¦æ­£å¸¸å·¥ä½œ</p>
        
        <div class="info">
            <strong>ğŸ“‹ ä½¿ç”¨æ­¥éª¤ï¼š</strong><br>
            1. ç¡®ä¿ä»£ç†æœåŠ¡å™¨å·²å¯åŠ¨ï¼š<code class="code">npm run proxy</code><br>
            2. å¡«å†™ä¸‹æ–¹è¡¨å•<br>
            3. ç‚¹å‡»"æµ‹è¯•è¿æ¥"
        </div>

        <div class="form-group">
            <label>
                <input type="checkbox" id="useProxy" checked>
                ä½¿ç”¨ä»£ç†æœåŠ¡å™¨
            </label>
        </div>

        <div class="form-group" id="proxyUrlGroup">
            <label for="proxyUrl">ä»£ç†æœåŠ¡å™¨åœ°å€</label>
            <input type="text" id="proxyUrl" value="http://localhost:3001/webdav-proxy" 
                   placeholder="http://localhost:3001/webdav-proxy">
        </div>

        <div class="form-group">
            <label for="webdavUrl">WebDAV æœåŠ¡å™¨åœ°å€</label>
            <input type="text" id="webdavUrl" value="https://dav.jianguoyun.com/dav/" 
                   placeholder="https://dav.jianguoyun.com/dav/">
        </div>

        <div class="form-group">
            <label for="username">ç”¨æˆ·å</label>
            <input type="text" id="username" placeholder="your-email@example.com">
        </div>

        <div class="form-group">
            <label for="password">å¯†ç </label>
            <input type="password" id="password" placeholder="åº”ç”¨å¯†ç ï¼ˆä¸æ˜¯ç™»å½•å¯†ç ï¼‰">
        </div>

        <button onclick="testConnection()" id="testBtn">ğŸ” æµ‹è¯•è¿æ¥</button>
        <button onclick="clearForm()">ğŸ—‘ï¸ æ¸…é™¤</button>

        <div id="result" class="result"></div>
    </div>

    <script>
        const useProxyCheckbox = document.getElementById('useProxy');
        const proxyUrlGroup = document.getElementById('proxyUrlGroup');
        
        useProxyCheckbox.addEventListener('change', () => {
            proxyUrlGroup.style.display = useProxyCheckbox.checked ? 'block' : 'none';
        });

        async function testConnection() {
            const useProxy = document.getElementById('useProxy').checked;
            const proxyUrl = document.getElementById('proxyUrl').value.trim();
            const webdavUrl = document.getElementById('webdavUrl').value.trim();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const result = document.getElementById('result');
            const testBtn = document.getElementById('testBtn');

            // éªŒè¯è¾“å…¥
            if (!webdavUrl || !username || !password) {
                showResult('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ', false);
                return;
            }

            if (useProxy && !proxyUrl) {
                showResult('è¯·å¡«å†™ä»£ç†æœåŠ¡å™¨åœ°å€', false);
                return;
            }

            // ç¦ç”¨æŒ‰é’®
            testBtn.disabled = true;
            testBtn.textContent = 'â³ æµ‹è¯•ä¸­...';
            result.style.display = 'none';

            try {
                // æ„å»ºè¯·æ±‚ URL
                let requestUrl;
                if (useProxy) {
                    const encodedUrl = encodeURIComponent(webdavUrl);
                    requestUrl = `${proxyUrl}/${encodedUrl}/`;
                } else {
                    requestUrl = webdavUrl;
                }

                console.log('æµ‹è¯• URL:', requestUrl);

                // å‘é€ PROPFIND è¯·æ±‚ï¼ˆWebDAV æ ‡å‡†æ–¹æ³•ï¼‰
                const response = await fetch(requestUrl, {
                    method: 'PROPFIND',
                    headers: {
                        'Authorization': 'Basic ' + btoa(username + ':' + password),
                        'Depth': '0',
                        'Content-Type': 'application/xml'
                    }
                });

                if (response.ok || response.status === 207) {
                    showResult(`âœ… è¿æ¥æˆåŠŸï¼\nçŠ¶æ€ç : ${response.status}\n${useProxy ? 'ä»£ç†æœåŠ¡å™¨å·¥ä½œæ­£å¸¸' : 'ç›´è¿æˆåŠŸ'}`, true);
                } else if (response.status === 401) {
                    showResult(`âŒ è®¤è¯å¤±è´¥ (401)\nè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç \næç¤ºï¼šåšæœäº‘éœ€è¦ä½¿ç”¨"åº”ç”¨å¯†ç "`, false);
                } else if (response.status === 404) {
                    showResult(`âŒ æœªæ‰¾åˆ°è·¯å¾„ (404)\nè¯·æ£€æŸ¥ WebDAV URL æ˜¯å¦æ­£ç¡®`, false);
                } else {
                    showResult(`âš ï¸ è¿æ¥å¤±è´¥\nçŠ¶æ€ç : ${response.status}\n${response.statusText}`, false);
                }
            } catch (error) {
                console.error('æµ‹è¯•é”™è¯¯:', error);
                let errorMsg = `âŒ è¿æ¥å¤±è´¥\né”™è¯¯: ${error.message}`;
                
                if (error.message.includes('Failed to fetch')) {
                    if (useProxy) {
                        errorMsg += '\n\nå¯èƒ½çš„åŸå› ï¼š\n1. ä»£ç†æœåŠ¡å™¨æœªå¯åŠ¨\n2. ä»£ç†æœåŠ¡å™¨åœ°å€é”™è¯¯';
                    } else {
                        errorMsg += '\n\nå¯èƒ½çš„åŸå› ï¼š\n1. CORS è·¨åŸŸé™åˆ¶ï¼ˆè¯·å¯ç”¨ä»£ç†ï¼‰\n2. ç½‘ç»œè¿æ¥é—®é¢˜\n3. WebDAV URL é”™è¯¯';
                    }
                }
                
                showResult(errorMsg, false);
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'ğŸ” æµ‹è¯•è¿æ¥';
            }
        }

        function showResult(message, isSuccess) {
            const result = document.getElementById('result');
            result.textContent = message;
            result.className = 'result ' + (isSuccess ? 'success' : 'error');
        }

        function clearForm() {
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('result').style.display = 'none';
        }
    </script>
</body>
</html>
